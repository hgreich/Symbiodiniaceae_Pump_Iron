---
title: "fig_3_thru_5_metal_figs"
author: "Hannah Reich"
date: "July 1, 2019"
output: html_document
---

```{r}
# these are the univariate metal figures
# figure 3 thru 5
# this data is all normalized to mol P

setwd("~/Desktop/PhD/EAPSI 2017/metaldatastats_FINAL/")

library(ggplot2)
library(cowplot)
library(readxl)
library(dplyr)
library(reshape2)
library(ggpubr)
library(Hmisc)
library(PMCMR)
library(lemon) # for reposition_legend() function

fw <- read_excel("~/Desktop/PhD/chapters/chapter 1 - metal quotas/submission_data_code/metal_data.xlsx",
                             sheet = "univar_figs")

# this is for organizing the figs
byspp_order <- c("smic50", "smic100", "smic250", "necro50", "necro100", "necro250", 
           "min50", "min100", "min250", "psyg50", "psyg100", "psyg250",
           "vor50", "vor100", "vor250")
iron_conc <- c("250", "500", "1250", "250", "500", "1250","250", "500", "1250","250", "500", "1250","250", "500", "1250")

# this is for the error bars
pd <- position_dodge(0.1)

# this is the color scheme
cols <- c("S. microadriaticum" = "darkorange1", "S. necroappetens" = "goldenrod1", "B. minutum" = "darkgreen", "B. psygmophilum" = "chartreuse2", "E. voratum" = "blue2")

# data wrangling
# melt the data
fwmelt <- melt(fw, id=c("treatment", "ironconc", "species"), measure.vars = c("specificgrowth", "Mn55", "Mn_uptake", "Mn_effic", "Fe56", "Fe_uptake", "Fe_effic", "Co59", "Co_uptake", "Co_effic", "Ni58", "Ni_uptake", "Ni_effic", "Cu63", "Cu_uptake", "Cu_effic", "Zn66", "Zn_uptake", "Zn_effic", "Mo95", "Mo_uptake", "Mo_effic", "V51", "V_uptake", "V_effic"))

# rename the variable levels so they are paper ready :)
levels(fwmelt$variable) <- c("Specific growth", "Manganese content", "Manganese uptake", "Manganese use efficiency", "Iron content", "Iron uptake", "Iron use efficiency", "Cobalt content", "Cobalt uptake", "Cobalt use efficiency", "Nickel content", "Nickel uptake", "Nickel use efficiency", "Copper content", "Copper uptake", "Copper use efficiency", "Zinc content", "Zinc uptake", "Zinc use efficiency", "Molybdenum content", "Molybdenum uptake", "Molybdenum use efficiency", "Vanadium content", "Vanadium uptake", "Vanadium use efficiency")

# get summary stats
fwstats <- fwmelt %>%
  group_by(treatment, ironconc, species, variable) %>%
  summarise(avg = mean(value,na.rm=T), sd = sd(value,na.rm=T))

# make object for content variables
content <- filter(fwstats, variable %in% c("Iron content", "Zinc content","Cobalt content", "Manganese content", "Nickel content", "Copper content", "Molybdenum content", "Vanadium content"))
# reorder factors in ideal order
content$variable <- factor(content$variable, levels = c("Iron content", "Zinc content","Cobalt content", "Manganese content", "Nickel content", "Copper content", "Molybdenum content", "Vanadium content"))

# make object for uptake variables
uptake <- filter(fwstats, variable %in% c("Manganese uptake", "Iron uptake", "Cobalt uptake", "Nickel uptake", "Copper uptake", "Zinc uptake", "Molybdenum uptake", "Vanadium uptake"))
# reorder factors
uptake$variable <- factor(uptake$variable, levels = c("Iron uptake", "Zinc uptake", "Cobalt uptake", "Manganese uptake", "Nickel uptake", "Copper uptake", "Molybdenum uptake", "Vanadium uptake"))

# make object for efficiency variables
effic <- filter(fwstats, variable %in% c("Manganese use efficiency", "Iron use efficiency", "Cobalt use efficiency", "Nickel use efficiency", "Copper use efficiency", "Zinc use efficiency", "Molybdenum use efficiency", "Vanadium use efficiency"))
# reorder factors
effic$variable <- factor(effic$variable, levels = c("Iron use efficiency", "Zinc use efficiency", "Cobalt use efficiency", "Manganese use efficiency", "Nickel use efficiency", "Copper use efficiency",  "Molybdenum use efficiency", "Vanadium use efficiency"))

###########################################################
####### figure 3, iron content, uptake rate, use efficiency
###########################################################

# make objects for fe content, fe uptake & fe effic for the new averages

fecontent <- filter(fwstats, variable %in% "Iron content")
feuptake <- filter(fwstats, variable %in% "Iron uptake")
feeffic <- filter(fwstats, variable %in% "Iron use efficiency")

# iron content
Fe_spp <- ggplot(fecontent, aes(x=treatment, y=avg, fill=species), order = byspp_order) + geom_bar(stat = "identity") + scale_x_discrete(limits = byspp_order, labels=iron_conc) +
  guides(colour = guide_legend(override.aes = list(size=3,linetype=0))) +
  theme(axis.text.x = element_text(angle=70, vjust=0.5)) +
  geom_errorbar(aes(ymin=avg-sd, ymax=avg+sd), width=0.75, colour="black", position=pd) +
  labs(y=expression(bold(mmol~metal~mol~P^-1)), title = "Iron Content", x = "  ") + 
  theme(axis.text = element_text(size=14)) + 
  theme(axis.title = element_text(size=14, face = "bold")) +
  theme(legend.text = element_text(size=14,face="italic")) + 
  theme(legend.title = element_text(size=14, face="bold")) +
  theme(legend.title.align=0.5) +
  theme(legend.position = "right")+
  theme(plot.title = element_text(size = 18, face = "bold")) +
  scale_fill_manual(values=cols, name = "Species",breaks=c("S. microadriaticum", "S. necroappetens", "B. minutum", "B. psygmophilum", "E. voratum")) + 
  scale_y_continuous(breaks=c(0,10,20)) +
  theme(legend.background = element_rect(fill="lightgrey",
                                  size=1, linetype="solid", 
                                  colour ="black"))
Fe_spp
#save_plot("Fe_spp_pmmol.png", Fe_spp, base_aspect_ratio = 1.3)

# uptake

Fe_uptake_pmmol <- ggplot(feuptake, aes(x=treatment, y=avg, fill=species)) + geom_bar(stat = "identity") + scale_x_discrete(limits = byspp_order, labels=iron_conc) +
  theme(axis.text.x = element_text(angle=70, vjust=0.5)) +
  geom_errorbar(aes(ymin=avg-sd, ymax=avg+sd), width=0.75, colour="black", position=pd) +
  labs(y=expression(bold(mmol~metal~mol~P^-1~day^-1)), title="Iron Uptake", x = "Bioavailable Iron Concentration (pM Fe')") +
  theme(axis.text = element_text(size=14)) +
  theme(axis.title = element_text(size=14, face = "bold")) +
  theme(legend.text = element_text(size=14,face="italic")) + 
  theme(legend.title = element_text(size=14, face="bold")) +
  theme(legend.title.align=0.5) +
  theme(legend.position = c(0.3,0.8))+
    theme(plot.title = element_text(size = 18, face = "bold")) +
  scale_fill_manual(values = cols, breaks=c("S. microadriaticum", "S. necroappetens", "B. minutum", "B. psygmophilum", "E. voratum")) +
  scale_y_continuous(breaks=c(0.0,2.5,5,7.5,10))
Fe_uptake_pmmol
#save_plot("Fe_uptake_pmmol.png", Fe_uptake_pmmol,base_aspect_ratio = 1.3)

# efficiency
Fe_effic_pmmol <- ggplot(feeffic, aes(x=treatment, y=avg, fill=species)) + geom_bar(stat = "identity") + scale_x_discrete(limits = byspp_order, labels=iron_conc) +
  theme(axis.text.x = element_text(angle=70, vjust=0.5)) +
  geom_errorbar(aes(ymin=avg-sd, ymax=avg+sd), width=0.75, colour="black", position=pd) +
  labs(x="  ",y=expression(bold(mol~P~mmol~metal^-1~day^-1)), title="Iron Use Efficiency") + 
  theme(axis.text = element_text(size=14)) + 
  theme(axis.title = element_text(size=14, face = "bold")) +
  theme(legend.text = element_text(size=14,face="italic")) + 
  theme(legend.title = element_text(size=14, face="bold")) +
  theme(legend.title.align=0.5) +
  theme(legend.position = c(0.3,0.8))+
  theme(plot.title = element_text(size = 18, face = "bold")) +
  scale_fill_manual(values = cols,breaks=c("S. microadriaticum", "S. necroappetens", "B. minutum", "B. psygmophilum", "E. voratum")) +
  scale_y_continuous(breaks=c(0.0,0.1,0.2,0.3,0.4, 0.5, 0.6))
Fe_effic_pmmol
#save_plot("Fe_effic_pmmol.png", Fe_effic_pmmol,base_aspect_ratio = 1.3)

# plot the figures together on a grid
legend <- get_legend(Fe_spp)
ironfigs <- plot_grid(Fe_spp + theme(legend.position="none"), Fe_uptake_pmmol + theme(legend.position="none"), Fe_effic_pmmol+ theme(legend.position = "none"), legend, ncol=4, nrow=1, labels = c('A','B','C', NULL), align = "v", label_size = 22)
save_plot("ironfigs.pdf", ironfigs,
          ncol=4, nrow=1, base_aspect_ratio = 1.3)

######################################################################
############# figure 4, metal content (non-iron) for the 5 species
######################################################################

# re-wrangle the melted data, take iron out so it does not take up too much space
# make object for content variables
content2 <- filter(fwstats, variable %in% c("Zinc content","Cobalt content", "Manganese content", "Nickel content", "Copper content", "Molybdenum content", "Vanadium content"))
# reorder factors in ideal order
content2$variable <- factor(content2$variable, levels = c("Zinc content","Cobalt content", "Manganese content", "Nickel content", "Copper content", "Molybdenum content", "Vanadium content"))
# rename levels to take content out to save space
levels(content2$variable) <- c("Zinc","Cobalt", "Manganese", "Nickel", "Copper", "Molybdenum", "Vanadium")

# make content figure
attach(content2)
contentfigv2 <- ggplot(content2, aes(x=treatment, y=avg, fill=species)) +
  geom_bar(stat = "identity", position = "dodge") +
  facet_wrap(~variable, scales = "free_y", nrow = 2, ncol=4) +
  theme(strip.text.x = element_text(size=8, margin = margin(.08, 0, .08, 0, "cm"))) +
  scale_fill_manual(values=cols, name = "Species",breaks=c("S. microadriaticum", "S. necroappetens", "B. minutum", "B. psygmophilum", "E. voratum"), labels = c("Symbiodinium microadriaticum", "Symbiodinium necroappetens", "Breviolum minutum", "Breviolum psygmophilum", "Effrenium voratum")) +
  theme(axis.text.x = element_text(angle=45, vjust=1, hjust=1)) +
  geom_errorbar(aes(ymin=avg-sd, ymax=avg+sd), width=0.75, colour="black", position=pd) +   scale_x_discrete(limits = byspp_order, labels=iron_conc) +
  theme(legend.key.size = unit(0.25, "cm")) +
  labs(x="Bioavailable Iron Concentration (pM Fe')", 
       y=expression(bold(Metal~Content~(mmol~metal~mol~P^-1))), 
title = "Metal content") + 
  theme(axis.text.y = element_text(size=6), axis.text.x = element_text(size=6)) + 
  theme(axis.title = element_text(size=10, face = "bold")) +
  theme(legend.text = element_text(size=6,face="italic"), legend.title = element_text(face = "bold",size = 8 ), plot.title = element_text(size=10, face = "bold"))
v3 <- reposition_legend(contentfigv2, 'center', panel = 'panel-4-2')
save_plot("contentfigv2.pdf", v3, base_aspect_ratio = 1.9)

######################################################################
############# figure 5, metal uptake vs efficiency for all species
######################################################################

# for facet wrap version
# make objects for each metal, then melt
# add metal column
# then join all of the datasets

# make objects for each metal
mo <- cbind(fw[,c(1:3,6,7)])
cu <- cbind(fw[,c(1:3,9,10)])
zn <- cbind(fw[,c(1:3,12,13)])
mn <- cbind(fw[,c(1:3,15,16)])
fe <- cbind(fw[,c(1:3,18,19)])
co <- cbind(fw[,c(1:3,21,22)])
ni <- cbind(fw[,c(1:3,24,25)])
v <- cbind(fw[,c(1:3,27,28)]) 

# rename uptake and efficiency column names
# and add the metal name too

# mo
colnames(mo)[colnames(mo)=="Mo_uptake"] <- "Uptake"
colnames(mo)[colnames(mo)=="Mo_effic"] <- "Effic"
mo$metal <- c("Molybdenum")

# cu
colnames(cu)[colnames(cu)=="Cu_uptake"] <- "Uptake"
colnames(cu)[colnames(cu)=="Cu_effic"] <- "Effic"
cu$metal <- c("Copper")

# zn
colnames(zn)[colnames(zn)=="Zn_uptake"] <- "Uptake"
colnames(zn)[colnames(zn)=="Zn_effic"] <- "Effic"
zn$metal <- c("Zinc")

# mn
colnames(mn)[colnames(mn)=="Mn_uptake"] <- "Uptake"
colnames(mn)[colnames(mn)=="Mn_effic"] <- "Effic"
mn$metal <- c("Manganese")

# fe
colnames(fe)[colnames(fe)=="Fe_uptake"] <- "Uptake"
colnames(fe)[colnames(fe)=="Fe_effic"] <- "Effic"
fe$metal <- c("Iron")

# co
colnames(co)[colnames(co)=="Co_uptake"] <- "Uptake"
colnames(co)[colnames(co)=="Co_effic"] <- "Effic"
co$metal <- c("Cobalt")

# ni
colnames(ni)[colnames(ni)=="Ni_uptake"] <- "Uptake"
colnames(ni)[colnames(ni)=="Ni_effic"] <- "Effic"
ni$metal <- c("Nickel")

# v
colnames(v)[colnames(v)=="V_uptake"] <- "Uptake"
colnames(v)[colnames(v)=="V_effic"] <- "Effic"
v$metal <- c("Vanadium")

# join all of the metals
m1 <- rbind(v,ni,zn,fe,co,mo,mn,cu)

m1<- as.data.frame(m1)
ironconc_fac <- as.factor(m1$ironconc)

# reorder factors 
m1$metal <- factor(m1$metal, levels = c("Iron", "Zinc", "Cobalt", "Manganese", "Nickel", "Copper", "Molybdenum", "Vanadium"))

# have to save differently for reposition fig to work
pdf("uptake_vs_effic.pdf", width = 15, height = 10)
fig <- ggplot(m1, aes(x = Uptake, y= Effic, color = as.factor(m1$species), shape = as.factor(m1$ironconc))) +
  geom_point(size = 4) +
  facet_wrap(~metal, scales = "free", ncol = 5) +
  scale_color_manual(values = cols,breaks=c("S. microadriaticum", "S. necroappetens", "B. minutum", "B. psygmophilum", "E. voratum"), name = "Species") +
  scale_shape_manual(values = c(2,0,1), breaks = c("50", "100", "250"), labels = c("250 pM Fe'", "500 pM Fe'", "1250 pM Fe'"), name = "Iron Concentration")  +
  theme(strip.text = element_text(size=18, face = "bold",
        margin = margin(.1, .1, .1, .1, "cm")),
        axis.text = element_text(size =16),
        axis.title = element_text(size = 20, face = "bold"),
        axis.text.x = element_text(angle=45, vjust=1, hjust=1)) +
  labs(y=expression(bold(Metal~Use~Efficiency~(mol~P~mmol~metal^-1~day^-1))),
       x=expression(bold(Metal~Uptake~(mmol~metal~mol~P^-1~day^-1)))) +
  theme(legend.text = element_text(size=16)) + 
  theme(legend.title = element_text(size=16, face="bold"))
reposition_legend(fig, 'center', panel = 'panel-3-2')
dev.off()

### loop this to make figures by each metal

metalfigz <- function(mycolumn) {
  for (i in 1:length(unique(mycolumn))) {
  mycolumn2 <- as.vector(unique(mycolumn))
    fdata <- filter(m1, mycolumn %in% unique(mycolumn)[i])
    myplot <- ggplot(fdata, aes(x = Uptake, y= Effic, color=as.factor(species), shape = as.factor(ironconc))) +
  geom_point(size = 3) +
  scale_color_manual(values = cols,breaks=c("S. microadriaticum", "S. necroappetens", "B. minutum", "B. psygmophilum", "E. voratum"), name = "Species") +
  scale_shape_manual(values = c(2,0,1), breaks = c("50", "100", "250"), labels = c("250 pM Fe'", "500 pM Fe'", "1250 pM Fe'"), name = "Iron Concentration")  +
  theme(axis.text = element_text(size =8),
        axis.title = element_text(size = 10, face = "bold"),
        axis.text.x = element_text(angle=45, vjust=1, hjust=1)) +
  labs( y=expression(bold(Metal~Use~Efficiency~(mol~P~mmol~metal^-1~day^-1))),
       x=expression(bold(Metal~Uptake~(mmol~metal~mol~P^-1~day^-1))), 
       title= paste0(mycolumn2[i])) +
  theme(legend.text = element_text(size=8)) + 
  theme(legend.title = element_text(size=8, face="bold")) +
      theme(legend.position = "right")
            save_plot(paste0(i, "_metal.pdf"), myplot, base_aspect_ratio = 1.6)
    myplot
  }
}

metalfigz(m1$metal)


#########################################################
######## all of the metal (uni-variate stats)
#########################################################

# re-attaches the data for the stats
fw <- read_excel("~/Desktop/PhD/chapters/chapter 1 - metal quotas/submission_data_code/metal_data.xlsx",
                             sheet = "univar_figs")
# rename
mds <- fw
attach(mds)
# make treatment a factor for the analysis
treat <- as.factor(treatment)
# do all of the stats

##### IRON

#### quota stats
shapiro.test(Fe56)
kruskal.test(Fe56~treat)
posthoc.kruskal.dunn.test(Fe56,treat,p.adjust.method = "fdr")

#### uptake stats
shapiro.test(Fe_uptake)
kruskal.test(Fe_uptake~treat)
posthoc.kruskal.dunn.test(Fe_uptake,treat,p.adjust.method = "fdr")

#### efficiency stats
shapiro.test(Fe_effic)
kruskal.test(Fe_effic~treat)
posthoc.kruskal.dunn.test(Fe_effic,treat,p.adjust.method = "fdr")

##### MANGANESE

#### quota stats
shapiro.test(Mn55)
kruskal.test(Mn55~treat)
posthoc.kruskal.dunn.test(Mn55,treat,p.adjust.method = "fdr")

#### uptake stats
shapiro.test(Mn_uptake)
kruskal.test(Mn_uptake~treat)
posthoc.kruskal.dunn.test(Mn_uptake,treat,p.adjust.method = "fdr")

#### efficiency stats
shapiro.test(Mn_effic)
kruskal.test(Mn_effic~treat)
posthoc.kruskal.dunn.test(Mn_effic,treat,p.adjust.method = "fdr")

##### COBALT

#### quota stats
shapiro.test(Co59)
kruskal.test(Co59~treat)
posthoc.kruskal.dunn.test(Co59,treat,p.adjust.method = "fdr")

#### uptake stats
shapiro.test(Co_uptake)
kruskal.test(Co_uptake~treat)
posthoc.kruskal.dunn.test(Co_uptake,treat,p.adjust.method = "fdr")

#### efficiency stats
shapiro.test(Co_effic)
kruskal.test(Co_effic~treat)
posthoc.kruskal.dunn.test(Co_effic,treat,p.adjust.method = "fdr")

##### NICKEL

#### quota stats
shapiro.test(Ni58)
kruskal.test(Ni58~treat)
posthoc.kruskal.dunn.test(Ni58,treat,p.adjust.method = "fdr")

#### uptake stats
shapiro.test(Ni_uptake)
kruskal.test(Ni_uptake~treat)
posthoc.kruskal.dunn.test(Ni_uptake,treat,p.adjust.method = "fdr")

#### efficiency stats
shapiro.test(Ni_effic)
kruskal.test(Ni_effic~treat)
posthoc.kruskal.dunn.test(Ni_effic,treat,p.adjust.method = "fdr")

##### COPPER

#### quota stats
shapiro.test(Cu63)
kruskal.test(Cu63~treat)
posthoc.kruskal.dunn.test(Cu63,treat,p.adjust.method = "fdr")

#### uptake stats
shapiro.test(Cu_uptake)
kruskal.test(Cu_uptake~treat)
posthoc.kruskal.dunn.test(Cu_uptake,treat,p.adjust.method = "fdr")

#### efficiency stats
shapiro.test(Cu_effic)
kruskal.test(Cu_effic~treat)
posthoc.kruskal.dunn.test(Cu_effic,treat,p.adjust.method = "fdr")

##### ZINC

#### quota stats
shapiro.test(Zn66)
kruskal.test(Zn66~treat)
posthoc.kruskal.dunn.test(Zn66,treat,p.adjust.method = "fdr")

#### uptake stats
shapiro.test(Zn_uptake)
kruskal.test(Zn_uptake~treat)
posthoc.kruskal.dunn.test(Zn_uptake,treat,p.adjust.method = "fdr")

#### efficiency stats
shapiro.test(Zn_effic)
kruskal.test(Zn_effic~treat)
posthoc.kruskal.dunn.test(Zn_effic,treat,p.adjust.method = "fdr")

##### MOLYBDENUM 

#### quota stats
shapiro.test(Mo95)
kruskal.test(Mo95~treat)
posthoc.kruskal.dunn.test(Mo95,treat,p.adjust.method = "fdr")

#### uptake stats
shapiro.test(Mo_uptake)
kruskal.test(Mo_uptake~treat)
posthoc.kruskal.dunn.test(Mo_uptake,treat,p.adjust.method = "fdr")

#### efficiency stats
shapiro.test(Mo_effic)
kruskal.test(Mo_effic~treat)
posthoc.kruskal.dunn.test(Mo_effic,treat,p.adjust.method = "fdr")

##### VANADIUM 

#### quota stats
shapiro.test(V51)
kruskal.test(V51~treat)
posthoc.kruskal.dunn.test(V51,treat,p.adjust.method = "fdr")

#### uptake stats
shapiro.test(V_uptake)
kruskal.test(V_uptake~treat)
posthoc.kruskal.dunn.test(V_uptake,treat,p.adjust.method = "fdr")

#### efficiency stats
shapiro.test(V_effic)
kruskal.test(V_effic~treat)
posthoc.kruskal.dunn.test(V_effic,treat,p.adjust.method = "fdr")

```

